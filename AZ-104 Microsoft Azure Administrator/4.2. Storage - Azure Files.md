# Azure Files

- 99.9% SLA with availability, redundancy and disaster recovery
- Typical use cases:
  - Lift and shift
  - Hybrid solutions
  - Born-in-cloud applications that require shared storage
  - Storage for cross-platform solutions
  - Any workload that currently uses a file server or NAS providing SMB access
- REST compatible
- **SMB**-compatible
  - File protocol over port 445
  - Can be mounted by Linux, Windows & macOS
  - Versions
    - **SMB 1**: Limited block sizes, chatty protocol
    - **SMB 2.1** *(Supported by Azure)*
      - No encryption
      - Better network performance than SMB 1.0
      - Group file shares, software shares
      - Supported >Windows 7, > Windows Server 2008
    - **SMB 3** *(Supported by Azure)*
      - Active-active support: Clustering with nodes
      - Transparent failover
      - RDMA support, multi channel > Lower latency
      - Enables usage of SQL and Hyper-V
      - Encryption support (in transit)
      - Supported > Windows 8, > Windows Server 2012
  - Talks through port 445 and outbound connection

## Microsoft Entra ID Kerberos for SMB - **NEW 2025**

- Azure Files now supports **Microsoft Entra ID Kerberos authentication** for SMB file shares
- Eliminates dependency on on-premises Active Directory for cloud-only identities
- Supports both cloud-only and hybrid environments
- Provides seamless integration with Entra ID without requiring domain join
- Simplifies identity management for Azure Files

## Azure File Share-Centric Management - **NEW 2025 (Preview)**

- New resource provider: `Microsoft.FileShares` (preview)
- File shares become **first-class resources** instead of being nested under storage accounts
- Simplifies role assignments and permissions management
- Enables **NFS v4.1 support** for file shares
- Better alignment with Azure resource management model
- **Create Azure File Share**
  - Multiple Azure File shares can be created under a storage account
  - Each has a name and optional quota assigned
    - Quota limits the size up to 5120 GB (standard)
    - Premium file shares: 32 GiB to 256 TiB with **Provisioned v2** model
  - In portal: Storage â†’ Files â†’ File Share

## Provisioned v2 File Shares - **NEW 2025**

- Premium file shares can provision storage capacity, IOPS, and throughput independently
- Sizes range from **32 GiB to 256 TiB**
- Provides predictable performance for enterprise workloads
- Ideal for applications requiring consistent low latency and high IOPS
- **File access**
  - Access is via standard SMB client
  - Dialect of SMB is negotiated between the client and Azure Files upon connection
  - Encryption in transit (TLS) for NFS file shares is now GA
  - **NFS v4.1 support** is available (preview)
  - SMB access methods:
    - Storage account name *(as user name)* and access key *(as password)*
    - Microsoft Entra ID Kerberos authentication
    - Active Directory integration (hybrid environments)
  - REST access can utilize SAS tokens
  - Azure File Sync supports **system-assigned managed identities** - no storage account keys needed

## Vaulted Backup for Azure Files - **NEW 2025**

- Azure Backup supports vaulted backup for **SSD file shares**
- Scheduled backups with retention up to **10 years**
- Data stored offsite in a recovery services vault
- Can be restored to an alternate storage account via the Business Continuity Center
- Provides long-term retention and offsite copy protection

## Azure File Snapshots

- Delta snapshot of a file share
- Read-only, you can download your snapshot or mount it.
- Azure Backup can schedule and manage snapshots
- â— 200 snapshots per file share
- If the file share is deleted all snapshots are also deleted

## Replication options

- DFS-R (before it was File Replication Service)
- `xcopy`, `robocopy`
- Considerations: locking of files, data consistency, amount of data replicated and maintaining ACLs.

### Azure File Sync

- Enables replication from a single Azure Files share to one or more Windows based file servers
  - Windows service are in a synchronization group.
- Utilizes an agent deployed on each Windows Server instance that's then registered with the Storage Sync service then added to a sync group.

#### Cloud tiering

- Least used data is moved to the cloud
  - Leaves a thumbprint on the server providing transparent access
  - Data is pulled down when access is requested.
- Tiering is based on maintaining a certain percentage of free space.
  - Ensures around 20% is always free in file server.
- Can be disabled
- Is scoped to a file sync namespace.
- â— File must be higher than 64 KB

#### Quality of Service (QoS)

- Default configuration: Server will consume maximum possible bandwidth for data transfer via the storage sync service
- Supports network limits to be configured
- For a VM based file server, QoS of the hypervisor can be used
- Azure File Sync now supports **system-assigned managed identities**
  - Eliminates the need for storage account keys
  - Provides more secure authentication method
  - Better aligns with Azure security best practices

#### Considerations

- Avoid actions that'd cause data to be pulled down from the cloud
  - E.g. anti-virus scans, backups on-premises
- ACL (Access Control Lists) are replicated to the cloud but are not enforced when accessed via Azure Files.
  - ðŸ’¡ Content should be restored to an IaaS VM file server to enable ACL enforcement.
- Data can be pre-seeded via **Azure Databox** with some caveats
  - Enables pre-seeding instead of full copy over the network.
- Be careful when combining other data replication technologies.

#### Workflow for replication

1. Deploy a storage account
2. Deploy a **Azure File Share**
3. Deploy **Storage Sync service**
   - Must be in same region as storage account
4. Create a **sync group**
   - Sync group has:
     - Storage account & file share
     - Server endpoints
     - Cloud endpoints
5. Register server
   1. On portal: Sync Service â†’ Registered Service â†’ Download **Azure File Sync Agent**
   2. Install the service and register the server
6. Add file share into the **sync group** as server endpoint
   - ðŸ’¡ You can have only 1 cloud endpoint for the same sync group
   - You can enable/disable cloud tiering
7. Install agent on file server
   - Supported >Windows Server 2012
   - Selected files can be skipped
8. Register server to the *storage sync service* as server endpoint

#### Scale and Limits

- **15** storage sync services per subscription
- **30** sync groups per storage service
- **1** cloud endpoint and **50** server endpoints per sync group
- **4** TB maximum space
- **100** GB maximum file size
- **64** KB minimum file size to be tiered

#### Troubleshooting

- Check if TCP 445 is open for outbound traffic (SMB) or port 111/2049 (NFS)
- In metrics you can monitor for problems
- On portal
  - In Sync Services â†’ Sync Groups â†’ Group â†’ See health status and action recommendations for problems for cloud and server endpoints
- In Event Viewer you can check FileSync events

## NFS File Share Considerations - **NEW 2025**

- **REST API support** for NFS file shares is in preview
- **Convert SSD file shares** between LRS and ZRS using private endpoints
- **NFS file shares:**
  - Cannot be accessed via SMB protocol
  - Are not supported on Windows clients
  - Do not support NFS ACLs
  - Support encryption in transit (TLS)

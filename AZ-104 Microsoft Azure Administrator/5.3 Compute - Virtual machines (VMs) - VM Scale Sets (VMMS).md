# VM Scale Sets (VMSS)

- Group that holds identically configured VMs
- Used for:
  - Need to create and manage multiple VMs
    - Centrally create and manage multiple VMs (Windows Server or Linux)
  - Need for high availability and app resiliency
    - Horizontal scaling, scaling up and down based on spikes
  - Need for large (1000) scale
    - E.g. Azure Batch uses scale sets under the hood
  - Need for IaaS autoscale
    - Scale out and in based on metrics based autoscale

## Orchestration Modes - **NEW 2025**

### Flexible Orchestration (Recommended)

- **Azure now recommends flexible orchestration mode** for VM scale sets
- Provides high availability across:
  - **Availability Zones**
  - **Fault domains**
- Allows mixing:
  - **Spot VMs** and regular instances in the same scale set
  - **Multiple VM sizes** in one scale set
- Features:
  - Metrics-based autoscaling
  - Instance protection
  - Standby pools
  - Controlled rolling upgrades
- More flexible than uniform orchestration
- Better suited for production workloads

### Uniform Orchestration (Legacy)

- Traditional scale set mode
- All instances use identical configuration
- More limited in flexibility compared to flexible mode

## PaaS Scaling vs IaaS Scaling

- Azure App Service
  - High agility at the expense of administrative power
  - The underlying Hyper-V Vms are almost totally abstracted from you
  - Easy manual, scheduled, or automatic scale out and scale back
- Virtual Machine Scale Set (VMSS)
  - Maximum administrative power at the expense of agility
  - VMSS represents Azure's approach to IaaS horizontal scaling

## Deploying a VM Scale Set

- Create virtual machine scale set
  - Availability zone
    - Scale scale sets across one or more availability zones
    - All regions do not support availability zones
  - Instance count & instance set
  - **Spot VMs** (replaces Low Priority)
    - Take advantage of unutilized capacity
      - Compute power that Azure is not using
      - Save costs (up to 90% discount)
    - Good for workloads that can handle interruption
      - Stateless workloads, batch processing, dev/test
      - VMs in the scale set may be evicted at any time
      - Eviction policies:
        - **Stop/Deallocate**: VMs are stopped and can be restarted
        - **Delete**: VMs are deleted and must be recreated
      - Eviction based on:
        - **Capacity**: Azure needs the capacity back
        - **Price**: When spot price exceeds your max price
  - Use managed disks (recommended)
    - Better availability and performance
    - Supports availability zones
  - Networking
    - Application Gateway
      - üí° Useful if your scale sets are web servers
      - ‚ùó Do not support RDP
    - Load Balancer
      - Supports RDP/SSH
      - You set public IP address name and domain name label (`domain-name.region.cloudapp.azure.com`)
- You can also use ARM template or Bicep to deploy scale sets with extensions

## Connecting to VMs

- In portal: Choose VM ‚Üí Settings ‚Üí Instances you can see all the instances
- To connect to individual instances you need load balancer and NAT (network address translation)
  - You can't RDP/SSH into individual instances directly
  - You can connect to load balancer IPs
    - In portal: Load Balancer ‚Üí Inbound NAT rules
  - NAT maps different VMs on different ports.

## Configuring Autoscale

- ***Manual***: Through Portal/SDK/CLI/PowerShell
- Autoscale
- ***Scheduled***: If you know when the load will be high you can plan for that and scale with time triggers
- ***Metrics***: Use various metrics from various sources to determine when to scale in/out
- Manage in VMSS ‚Üí Scaling ‚Üí
  - Enable auto-scaling
  - Select scale-mode
  - **Scale based on metric**
    - Add rule
    - E.g. increase instance count by 1 when CPU percentage above 70%
    - üí° You should also create scale mode that bring down the scale count
    - Properties
      - Duration: Good to not be confused when scaling out/in, so set a duration to e.g. 10 minutes
      - Cooldown: Waits after scale operation before new scale operation
  - **Scale to specific instance count**
    - Time-based scaling
    - Set start and end date
